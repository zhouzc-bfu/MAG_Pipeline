import pandas as pd
from ete3 import Tree

# ==========================================
# ğŸ¨ é…è‰²æ–¹æ¡ˆï¼šNature æ ¸å¿ƒ + è¾…åŠ© + Others ç°
# ==========================================

# 1. Nature (NPG) å®˜æ–¹æ ‡å‡†è‰² (Top 1-10)
NPG_TOP10 = [
    "#E64B35", "#4DBBD5", "#00A087", "#3C5488", "#F39B7F",
    "#8491B4", "#91D1C2", "#DC0000", "#7E6148", "#B09C85"
]

# 2. ç›¸åŒé£æ ¼çš„è¾…åŠ©è‰² (Top 11-20)
SUPP_10 = [
    "#3B4992", "#EE0000", "#008B45", "#631879", "#008280",
    "#BB0021", "#5F559B", "#A20056", "#1F77B4", "#FF7F0E"
]

# 3. å…¶ä»–åˆ†ç±»çš„é¢œè‰² (Others)
OTHER_COLOR = "#D9D9D9"  # æµ…ç°è‰²

# åˆå¹¶è‰²æ¿
FULL_PALETTE = NPG_TOP10 + SUPP_10
# ==========================================

# --- 1. æ•°æ®ç»Ÿè®¡ ---
df_bac = pd.read_csv("5_classification_gtdbtk/gtdbtk.bac120.summary.tsv", sep='\t')
df_arc = pd.read_csv("5_classification_gtdbtk/gtdbtk.ar53.summary.tsv", sep='\t')
df = pd.concat([df_bac, df_arc])
df['user_genome'] = df['user_genome'].str.replace('.fa', '', regex=False).str.replace('.fasta', '', regex=False)

def get_phylum(x):
    if pd.isna(x) or ';' not in str(x): return "Unclassified"
    try: return x.split(';')[1].split('__')[1]
    except: return "Unclassified"
df['phylum'] = df['classification'].apply(get_phylum)

top20_names = df['phylum'].value_counts().head(20).index.tolist()
color_map = {name: FULL_PALETTE[i] for i, name in enumerate(top20_names)}

# å»ºç«‹ ID ç´¢å¼•
style_dict = {}
for _, row in df.iterrows():
    gid = row['user_genome']
    p = row['phylum']
    if p in top20_names:
        style_dict[gid] = (p, color_map[p])
    else:
        style_dict[gid] = ("Others", OTHER_COLOR)

# --- 2. å¤„ç†è¿›åŒ–æ ‘ ---
t = Tree("7_phylogenetic_tree_phylophlan/phylophlan_tree/RAxML_bestTree.dereplicated_genomes_refined.tre")

def propagate(node):
    if node.is_leaf():
        val = style_dict.get(node.name) or style_dict.get(node.name.replace('.fa',''))
        if val:
            node.add_feature("c", val[1])
            return val[1]
        return None
    else:
        child_c = [propagate(child) for child in node.children]
        valid = [x for x in child_c if x]
        # ã€å…³é”®ä¿®æ­£ã€‘ï¼š
        # å¦‚æœæ‰€æœ‰å­èŠ‚ç‚¹é¢œè‰²ä¸€è‡´ï¼ˆåŒ…æ‹¬éƒ½æ˜¯ç°è‰²ï¼‰ï¼Œåˆ™å‘ä¸Šæ¶‚è‰²
        if valid and all(x == valid[0] for x in valid) and len(valid) == len(child_c):
            node.add_feature("c", valid[0])
            return valid[0]
        # å¦‚æœå­èŠ‚ç‚¹é¢œè‰²ä¸ä¸€è‡´ï¼ˆå³åˆ°äº†ä¸åŒé—¨çš„åˆ†å‰å¤„ï¼‰ï¼Œè¿”å› None
        # è¿”å› None ä¼šå¯¼è‡´è¿™ä¸ªç¥–å…ˆèŠ‚ç‚¹æ²¡æœ‰ 'c' å±æ€§ï¼ŒiTOL å°±ä¼šé»˜è®¤æ˜¾ç¤ºä¸ºé»‘è‰²
        return None

propagate(t)

# å‘½åå†…éƒ¨èŠ‚ç‚¹
counter = 0
for n in t.traverse():
    if not n.is_leaf() and not n.name:
        n.name = f"Node_{counter}"; counter += 1

# --- 3. å¯¼å‡ºæ–‡ä»¶ ---
t.write(outfile="itol_tree.nwk", format=1)

# A. å¤–åœˆè‰²ç¯ (åŒ…å« Top 20 å’Œ Others)
with open("itol_tree_strip.txt", "w") as f:
    f.write("DATASET_COLORSTRIP\nSEPARATOR TAB\nDATASET_LABEL\tPhylum_Ring\nSTRIP_WIDTH\t50\nDATA\n")
    for gid, (label, color) in style_dict.items():
        f.write(f"{gid}\t{color}\t{label}\n")

# B. æ ‘æç€è‰² (å…³é”®ä¿®å¤)
with open("itol_tree_branch.txt", "w") as f:
    f.write("TREE_COLORS\nSEPARATOR TAB\nDATA\n")
    for n in t.traverse():
        # åªæœ‰æ˜ç¡®åˆ†é…äº†é¢œè‰²çš„èŠ‚ç‚¹ï¼ˆTop20 ç°‡ æˆ– çº¯ Others ç°‡ï¼‰æ‰ä¼šå†™è¿›é…ç½®
        if hasattr(n, "c"):
            f.write(f"{n.name}\tbranch\t{n.c}\tnormal\t1\n")
        # æ··åˆé—¨ç±»çš„ç¥–å…ˆä¸»å¹²æ²¡æœ‰ 'c' å±æ€§ï¼Œä¸ä¼šå†™è¿›æ–‡ä»¶ï¼ŒiTOL è‡ªåŠ¨æ˜¾ç¤ºä¸ºé»‘è‰²

print("âœ… æœ€ç»ˆç‰ˆå·²ç”Ÿæˆï¼")
print("1. Top 1-10: Nature NPG é…è‰²")
print("2. Top 11-20: è¾…åŠ©é£æ ¼é…è‰²")
print("3. Others: æµ…ç°è‰²åˆ†æ”¯")
print("4. ä¸»å¹²é“: è‡ªåŠ¨æ¢å¤ä¸ºé»‘è‰²")
